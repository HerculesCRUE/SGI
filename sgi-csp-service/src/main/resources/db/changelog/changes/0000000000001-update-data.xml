<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext" xmlns:pro="http://www.liquibase.org/xml/ns/pro" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd http://www.liquibase.org/xml/ns/pro http://www.liquibase.org/xml/ns/pro/liquibase-pro-3.8.xsd http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">
  <property name="schemaPrefix" value="" />

  <changeSet context="!test" author="master" id="0000000000001-solicitud_proyecto_entidad">
    <!-- Carga de la nueva tabla solicitud_proyecto_entidad a partir de datos existentes en convocatoria_entidad_financiadora -->
    <sql dbms="!postgresql">INSERT INTO ${schemaPrefix}solicitud_proyecto_entidad(id, created_by, creation_date, last_modified_by, last_modified_date, solicitud_proyecto_id, convocatoria_entidad_financiadora_id, convocatoria_entidad_gestora_id, solicitud_proyecto_entidad_financiadora_ajena_id) 
      SELECT 
        ${schemaPrefix}solicitud_proyecto_entidad_seq.NEXTVAL AS id,
        s.created_by,
        s.creation_date,
        s.last_modified_by,
        s.last_modified_date,
        s.id AS solicitud_proyecto_id,
        cef.id AS convocatoria_entidad_financiadora_id,
        null AS convocatoria_entidad_gestora_id,
        null AS solicitud_proyecto_entidad_financiadora_ajena_id
      FROM ${schemaPrefix}convocatoria_entidad_financiadora cef 
        JOIN ${schemaPrefix}solicitud s ON s.convocatoria_id = cef.convocatoria_id
        JOIN ${schemaPrefix}solicitud_proyecto sp ON sp.id = s.id
    </sql>
    <sql dbms="postgresql">INSERT INTO ${schemaPrefix}solicitud_proyecto_entidad(id, created_by, creation_date, last_modified_by, last_modified_date, solicitud_proyecto_id, convocatoria_entidad_financiadora_id, convocatoria_entidad_gestora_id, solicitud_proyecto_entidad_financiadora_ajena_id) 
      SELECT 
        nextval('${schemaPrefix}solicitud_proyecto_entidad_seq') AS id,
        s.created_by,
        s.creation_date,
        s.last_modified_by,
        s.last_modified_date,
        s.id AS solicitud_proyecto_id,
        cef.id AS convocatoria_entidad_financiadora_id,
        null AS convocatoria_entidad_gestora_id,
        null AS solicitud_proyecto_entidad_financiadora_ajena_id
      FROM ${schemaPrefix}convocatoria_entidad_financiadora cef 
        JOIN ${schemaPrefix}solicitud s ON s.convocatoria_id = cef.convocatoria_id
        JOIN ${schemaPrefix}solicitud_proyecto sp ON sp.id = s.id
    </sql>
    <!-- Carga de la nueva tabla solicitud_proyecto_entidad a partir de datos existentes en convocatoria_entidad_gestora -->
    <sql dbms="!postgresql">INSERT INTO ${schemaPrefix}solicitud_proyecto_entidad(id, created_by, creation_date, last_modified_by, last_modified_date, solicitud_proyecto_id, convocatoria_entidad_financiadora_id, convocatoria_entidad_gestora_id, solicitud_proyecto_entidad_financiadora_ajena_id) 
      SELECT 
        ${schemaPrefix}solicitud_proyecto_entidad_seq.NEXTVAL AS id,
        s.created_by,
        s.creation_date,
        s.last_modified_by,
        s.last_modified_date,
        s.id AS solicitud_proyecto_id,
        null AS convocatoria_entidad_financiadora_id,
        ceg.id AS convocatoria_entidad_gestora_id,
        null AS solicitud_proyecto_entidad_financiadora_ajena_id
      FROM ${schemaPrefix}convocatoria_entidad_gestora ceg 
        JOIN ${schemaPrefix}solicitud s ON s.convocatoria_id = ceg.convocatoria_id
        JOIN ${schemaPrefix}solicitud_proyecto sp ON sp.id = s.id
    </sql>
    <sql dbms="postgresql">INSERT INTO ${schemaPrefix}solicitud_proyecto_entidad(id, created_by, creation_date, last_modified_by, last_modified_date, solicitud_proyecto_id, convocatoria_entidad_financiadora_id, convocatoria_entidad_gestora_id, solicitud_proyecto_entidad_financiadora_ajena_id) 
      SELECT 
        nextval('${schemaPrefix}solicitud_proyecto_entidad_seq') AS id,
        s.created_by,
        s.creation_date,
        s.last_modified_by,
        s.last_modified_date,
        s.id AS solicitud_proyecto_id,
        null AS convocatoria_entidad_financiadora_id,
        ceg.id AS convocatoria_entidad_gestora_id,
        null AS solicitud_proyecto_entidad_financiadora_ajena_id
      FROM ${schemaPrefix}convocatoria_entidad_gestora ceg 
        JOIN ${schemaPrefix}solicitud s ON s.convocatoria_id = ceg.convocatoria_id
        JOIN ${schemaPrefix}solicitud_proyecto sp ON sp.id = s.id
    </sql>
    <!-- Carga de la nueva tabla solicitud_proyecto_entidad a partir de datos existentes en solicitud_proyecto_entidad_financiadora_ajena -->
    <sql dbms="!postgresql">INSERT INTO ${schemaPrefix}solicitud_proyecto_entidad(id, created_by, creation_date, last_modified_by, last_modified_date, solicitud_proyecto_id, convocatoria_entidad_financiadora_id, convocatoria_entidad_gestora_id, solicitud_proyecto_entidad_financiadora_ajena_id) 
      SELECT 
        ${schemaPrefix}solicitud_proyecto_entidad_seq.NEXTVAL AS id,
        spefa.created_by,
        spefa.creation_date,
        spefa.last_modified_by,
        spefa.last_modified_date,
        spefa.solicitud_proyecto_id AS solicitud_proyecto_id,
        null AS convocatoria_entidad_financiadora_id,
        null AS convocatoria_entidad_gestora_id,
        spefa.id AS solicitud_proyecto_entidad_financiadora_ajena_id
      FROM ${schemaPrefix}solicitud_proyecto_entidad_financiadora_ajena spefa
    </sql>
    <sql dbms="postgresql">INSERT INTO ${schemaPrefix}solicitud_proyecto_entidad(id, created_by, creation_date, last_modified_by, last_modified_date, solicitud_proyecto_id, convocatoria_entidad_financiadora_id, convocatoria_entidad_gestora_id, solicitud_proyecto_entidad_financiadora_ajena_id) 
      SELECT 
        nextval('${schemaPrefix}solicitud_proyecto_entidad_seq') AS id,
        spefa.created_by,
        spefa.creation_date,
        spefa.last_modified_by,
        spefa.last_modified_date,
        spefa.solicitud_proyecto_id AS solicitud_proyecto_id,
        null AS convocatoria_entidad_financiadora_id,
        null AS convocatoria_entidad_gestora_id,
        spefa.id AS solicitud_proyecto_entidad_financiadora_ajena_id
      FROM ${schemaPrefix}solicitud_proyecto_entidad_financiadora_ajena spefa
    </sql>
  </changeSet>

  <changeSet context="!test" author="master" id="0000000000001-solicitud_proyecto_presupuesto">
    <!-- Actualizar solicitud_proyecto_entidad_id en solicitud_proyecto_presupuesto -->
    <sql>
      UPDATE ${schemaPrefix}solicitud_proyecto_presupuesto spp SET solicitud_proyecto_entidad_id=(
        SELECT
          spe.id
        FROM ${schemaPrefix}solicitud_proyecto_entidad spe
          JOIN ${schemaPrefix}solicitud_proyecto_entidad_financiadora_ajena spefa ON spe.solicitud_proyecto_entidad_financiadora_ajena_id = spefa.id
        WHERE 
          spp.solicitud_proyecto_id = spefa.solicitud_proyecto_id
          AND spp.financiacion_ajena = '1' AND spp.entidad_ref = spefa.entidad_ref
      )
      WHERE spp.financiacion_ajena = '1' 
    </sql>
    <sql>
      UPDATE ${schemaPrefix}solicitud_proyecto_presupuesto spp SET solicitud_proyecto_entidad_id=(
        SELECT
          spe.id
        FROM ${schemaPrefix}solicitud_proyecto_entidad spe
          JOIN ${schemaPrefix}convocatoria_entidad_financiadora cef ON spe.convocatoria_entidad_financiadora_id = cef.id
          JOIN ${schemaPrefix}solicitud s ON s.convocatoria_id = cef.convocatoria_id
          JOIN ${schemaPrefix}solicitud_proyecto sp ON sp.id = s.id
        WHERE 
          spp.solicitud_proyecto_id = sp.id
          AND spp.financiacion_ajena = '0' 
          AND spp.entidad_ref = cef.entidad_ref
          AND sp.tipo_presupuesto = 'POR_ENTIDAD'
      )
      WHERE spp.financiacion_ajena = '0'
    </sql>
    <sql>
      UPDATE ${schemaPrefix}solicitud_proyecto_presupuesto spp SET solicitud_proyecto_entidad_id=(
        SELECT
          spe.id
        FROM ${schemaPrefix}solicitud_proyecto_entidad spe
          JOIN ${schemaPrefix}convocatoria_entidad_gestora ceg ON spe.convocatoria_entidad_gestora_id = ceg.id
          JOIN ${schemaPrefix}solicitud s ON s.convocatoria_id = ceg.convocatoria_id
          JOIN ${schemaPrefix}solicitud_proyecto sp ON sp.id = s.id
        WHERE 
          spp.solicitud_proyecto_id = sp.id
          AND spp.financiacion_ajena = '0' 
          AND spp.entidad_ref = ceg.entidad_ref
          AND sp.tipo_presupuesto = 'MIXTO'
      )
      WHERE spp.financiacion_ajena = '0' AND spp.solicitud_proyecto_entidad_id IS NULL 
    </sql>
  </changeSet>

  <changeSet context="!test" author="master" id="0000000000001-solicitud">
    <update tableName="solicitud">
      <column name="formulario_solicitud" value="PROYECTO" />
      <where>:name=:value</where>
      <whereParams>
        <param name="formulario_solicitud" value="ESTANDAR" />
      </whereParams>
    </update>
  </changeSet>

  <changeSet context="!test" author="master" id="0000000000001-configuracion_solicitud">
    <update tableName="configuracion_solicitud">
      <column name="formulario_solicitud" value="PROYECTO" />
      <where>:name=:value</where>
      <whereParams>
        <param name="formulario_solicitud" value="ESTANDAR" />
      </whereParams>
    </update>
  </changeSet>

  <changeSet context="!test" author="master" id="0000000000001-convocatoria">
    <sql>
      UPDATE ${schemaPrefix}convocatoria conv SET formulario_solicitud=(
        SELECT
          conf.formulario_solicitud
        FROM ${schemaPrefix}configuracion_solicitud conf WHERE 
          conf.convocatoria_id=conv.id 
      )
    </sql>
  </changeSet>
</databaseChangeLog>